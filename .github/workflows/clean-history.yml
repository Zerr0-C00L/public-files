name: Clean History of Specific Files

on:
  schedule:
    # Runs at 12:00 UTC on the 1st of every month (8:00 PM GMT+8)
    - cron: '0 12 1 * *'
  workflow_dispatch:  # Allows manual triggering

jobs:
  clean_workflow_runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    
    steps:
    - name: Delete old workflow runs
      uses: actions/github-script@v7
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          
          // Get all workflows
          const workflows = await github.rest.actions.listRepoWorkflows({
            owner,
            repo,
          });
          
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - 30); // Keep last 30 days
          
          let deletedCount = 0;
          
          for (const workflow of workflows.data.workflows) {
            // Get runs for this workflow
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflow.id,
              per_page: 100,
            });
            
            for (const run of runs.data.workflow_runs) {
              const runDate = new Date(run.created_at);
              if (runDate < cutoffDate) {
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id,
                  });
                  deletedCount++;
                  console.log(`Deleted run ${run.id} from ${workflow.name} (${run.created_at})`);
                } catch (error) {
                  console.log(`Failed to delete run ${run.id}: ${error.message}`);
                }
              }
            }
          }
          
          console.log(`Total deleted: ${deletedCount} workflow runs`);

  clean_git_history:
    runs-on: ubuntu-latest
    needs: clean_workflow_runs
    permissions:
      contents: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all branches and tags

    - name: Configure Git
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"

    - name: Save Current Versions of Files
      run: |
        mkdir -p /tmp/backup
        cp adult-movies.json /tmp/backup/adult-movies.json.bak || true
        cp epg.xml /tmp/backup/epg.xml.bak || true
        cp playlist.json /tmp/backup/playlist.json.bak || true
        cp playlist.m3u8 /tmp/backup/playlist.m3u8.bak || true
        cp tv_playlist.json /tmp/backup/tv_playlist.json.bak || true
        cp collections_playlist.json /tmp/backup/collections_playlist.json.bak || true
        cp Pluto-TV/us.m3u8 /tmp/backup/us.m3u8.bak || true
        cp Pluto-TV/us.xml /tmp/backup/us.xml.bak || true

    - name: Install Git Filter-Repo
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget -O ~/git-filter-repo https://raw.githubusercontent.com/newren/git-filter-repo/main/git-filter-repo
        chmod +x ~/git-filter-repo
        sudo mv ~/git-filter-repo /usr/local/bin/

    - name: Run Git Filter-Repo
      run: |
        git filter-repo --force --path adult-movies.json \
                        --path epg.xml \
                        --path playlist.json \
                        --path playlist.m3u8 \
                        --path tv_playlist.json \
                        --path collections_playlist.json \
                        --path Pluto-TV/us.m3u8 \
                        --path Pluto-TV/us.xml \
                        --invert-paths

    - name: Restore Current Versions of Files
      run: |
        mkdir -p Pluto-TV
        cp /tmp/backup/adult-movies.json.bak adult-movies.json || echo "File not found: adult-movies.json"
        cp /tmp/backup/epg.xml.bak epg.xml || echo "File not found: epg.xml"
        cp /tmp/backup/playlist.json.bak playlist.json || echo "File not found: playlist.json"
        cp /tmp/backup/playlist.m3u8.bak playlist.m3u8 || echo "File not found: playlist.m3u8"
        cp /tmp/backup/tv_playlist.json.bak tv_playlist.json || echo "File not found: tv_playlist.json"
        cp /tmp/backup/collections_playlist.json.bak collections_playlist.json || echo "File not found: collections_playlist.json"
        cp /tmp/backup/us.m3u8.bak Pluto-TV/us.m3u8 || echo "File not found: us.m3u8"
        cp /tmp/backup/us.xml.bak Pluto-TV/us.xml || echo "File not found: us.xml"
        git add adult-movies.json epg.xml playlist.json playlist.m3u8 tv_playlist.json collections_playlist.json Pluto-TV/us.m3u8 Pluto-TV/us.xml
        git commit -m "Re-add current versions of files after history clean" || echo "No changes to commit"

    - name: Force Push
      run: |
        git push origin main --force
